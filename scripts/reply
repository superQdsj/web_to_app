#!/usr/bin/env bash
set -euo pipefail

root_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
dart_dir="$root_dir/nga_fetcher_dart"
env_file="$root_dir/.env"

usage() {
  cat <<'EOF'
Usage:
  ./scripts/reply --tid <tid> --fid <fid> --content <text> [--pid <pid>]

Options:
  --tid <tid>       Thread ID (required)
  --fid <fid>       Forum ID (required)
  --content <text>  Reply content (required)
  --pid <pid>       Post ID to reply to (optional, for reply-to-reply)

Examples:
  # Reply to thread (main post)
  ./scripts/reply --tid 45960168 --fid -444012 --content "这是帖子的回复内容"

  # Reply to another user's post
  ./scripts/reply --tid 46010807 --fid -7 --pid 854923301 --content "这是回复其他用户的回复"

Notes:
- Uses: fvm dart run nga_fetcher_dart reply
- Cookie sources (in priority order):
  1. NGA_COOKIE environment variable
  2. .env file with NGA_COOKIE=...
- Response errors are printed to stderr and exit code is non-zero
EOF
}

if [[ $# -lt 1 ]]; then
  usage
  exit 2
fi

if ! command -v fvm >/dev/null 2>&1; then
  echo "ERROR: fvm not found in PATH" >&2
  exit 1
fi

if [[ ! -d "$dart_dir" ]]; then
  echo "ERROR: dart project not found: $dart_dir" >&2
  exit 1
fi

# Cookie must be provided via NGA_COOKIE or .env
if [[ ! -f "$env_file" && -z "${NGA_COOKIE:-}" ]]; then
  echo "WARNING: No cookie source found. Expecting NGA_COOKIE in .env or environment." >&2
fi

if [[ "$1" == "-h" || "$1" == "--help" || "$1" == "help" ]]; then
  usage
  exit 0
fi

(
  cd "$dart_dir"
  fvm dart run nga_fetcher_dart reply \
    "$@"
)
