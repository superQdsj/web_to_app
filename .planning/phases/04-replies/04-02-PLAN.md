---
phase: 04-replies
plan: "02"
type: execute
wave: 1
depends_on:
  - 04-01
files_modified:
  - nga_app/lib/screens/thread/thread_reply_composer.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can type a reply in the composer"
    - "User can submit the reply to NGA server"
    - "User sees loading indicator during submission"
    - "User sees success feedback after posting"
    - "User sees error feedback if posting fails"
  artifacts:
    - path: nga_app/lib/screens/thread/thread_reply_composer.dart
      provides: "Stateful reply composer with submission handling"
      exports: "_ReplyComposerState with submit, loading, error, success states"
  key_links:
    - from: _ReplyComposerState._submitReply()
      to: NgaRepository.postReply()
      via: "await repository.postReply(widget.tid, content)"
    - from: TextField
      to: TextEditingController
      via: "controller: _textController, clear on success"
    - from: Send button
      to: Loading state
      via: "CircularProgressIndicator when _submitting == true"
</objective>

<objective>
Convert the existing stateless `_ReplyComposer` to a stateful widget with full submission handling.

Purpose: Transforms the UI stub into a functional reply composer with loading states, error handling, and success feedback. Users can compose and submit replies with clear visual feedback.

Output: Stateful `_ReplyComposer` widget with TextField, send button, loading spinner, and SnackBar feedback.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@./nga_app/lib/screens/thread/thread_reply_composer.dart
@./nga_app/lib/src/auth/nga_cookie_store.dart
@./.planning/phases/04-replies/04-REPLY-RESEARCH.md

**Key patterns from existing code:**
- _ReplyComposer currently has TextField and IconButton send button
- Uses `_ThreadPalette` for colors
- Widget is part of `thread_screen.dart` (has `part of '../thread_screen.dart';`)
- Need to import NgaRepository and NgaCookieStore
</context>

<tasks>

<task type="auto">
  <name>Convert _ReplyComposer to stateful widget</name>
  <files>nga_app/lib/screens/thread/thread_reply_composer.dart</files>
  <action>
Convert the stateless _ReplyComposer to stateful with full submission handling:

1. Change class declaration:
   ```dart
   class _ReplyComposer extends StatefulWidget {
     const _ReplyComposer({required this.tid});

     final int tid;

     @override
     State<_ReplyComposer> createState() => _ReplyComposerState();
   }
   ```

2. Create _ReplyComposerState with:
   - `final _textController = TextEditingController();`
   - `final _focusNode = FocusNode();`
   - `bool _submitting = false;`
   - `String? _error;`

3. Implement `_submitReply()` async method:
   - Get trimmed content from controller
   - Validate non-empty, return early if empty
   - SetState: _submitting = true, _error = null
   - Try: await NgaRepository(cookie: NgaCookieStore.cookie.value).postReply(widget.tid, content)
   - On success: clear controller, show success SnackBar
   - On catch: setState _error = e.toString()
   - Finally: setState _submitting = false

4. Implement `_showSuccessSnackBar()` helper:
   - Uses ScaffoldMessenger.of(context).showSnackBar
   - Shows "回复发布成功" message with check icon

5. Override dispose(): controller.dispose(), focusNode.dispose(), super.dispose()

6. Update build() method:
   - Pass tid to constructor (already in file as part of thread_screen.dart - verify)
   - Connect TextField: controller: _textController, enabled: !_submitting
   - Connect error: decoration: errorText: _error
   - Replace send IconButton with conditional:
     - If _submitting: CircularProgressIndicator (strokeWidth: 2, size 18)
     - Else: Container with IconButton, onPressed: _submitReply only if content not empty
   - Add onSubmitted: _submitting ? null : (_) => _submitReply()

7. Add required imports at top of file:
   - `import '../../data/nga_repository.dart';`
   - `import '../../src/auth/nga_cookie_store.dart';`
  </action>
  <verify>
`flutter analyze nga_app/lib/screens/thread/thread_reply_composer.dart` passes, and the file contains `class _ReplyComposerState extends State` with `_submitReply()` method
  </verify>
  <done>
Reply composer is stateful with loading spinner during submission, error text displayed when posting fails, and success SnackBar shown when reply is posted. User can type, submit, and receive feedback.
</done>
</task>

</tasks>

<verification>
Run `flutter analyze` on the modified file and verify the composer can handle the complete submission flow: typing content -> pressing send -> loading state -> success/error feedback.
</verification>

<success_criteria>
- _ReplyComposer converted to StatefulWidget
- Text editing works with TextEditingController
- Send button shows loading spinner during submission
- Error messages display in TextField decoration
- Success shows SnackBar with confirmation
- Input clears on successful submission
</success_criteria>

<output>
After completion, create `.planning/phases/04-replies/04-02-SUMMARY.md`
</output>
