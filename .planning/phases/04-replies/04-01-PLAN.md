---
phase: 04-replies
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - nga_app/lib/data/nga_repository.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Reply content can be sent to NGA server"
    - "Reply submission handles network errors gracefully"
    - "Success or failure is detectable from API response"
  artifacts:
    - path: nga_app/lib/data/nga_repository.dart
      provides: "postReply() method for API submission"
      exports: "postReply()"
  key_links:
    - from: postReply()
      to: NgaHttpClient.postBytes()
      via: "POST to post.php with act=reply"
    - from: postReply()
      to: Response parsing
      via: "Success detection from HTML response"
---

<objective>
Add `postReply()` method to NgaRepository for submitting replies to NGA threads.

Purpose: Provides the API integration layer for reply functionality. Enables the composer UI to submit replies through a clean repository pattern.

Output: NgaRepository with `postReply(int tid, String content)` method that POSTs to NGA API and returns success/failure.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@./nga_app/lib/data/nga_repository.dart
@./nga_app/lib/src/http/nga_http_client.dart
@./.planning/phases/04-replies/04-REPLY-RESEARCH.md

**Key patterns from existing code:**
- NgaRepository uses `_baseUrl = 'https://bbs.nga.cn'` and `_client.postBytes()`
- Cookie is passed via `cookieHeaderValue: _cookie`
- Response decoding uses `_decodeResponse()` helper
- HTTP status check: `if (resp.statusCode != 200) throw Exception(...)`
</context>

<tasks>

<task type="auto">
  <name>Add postReply() method to NgaRepository</name>
  <files>nga_app/lib/data/nga_repository.dart</files>
  <action>
Add `postReply()` method to NgaRepository class after the existing `fetchThread()` method:

1. Method signature:
   ```dart
   Future<void> postReply(int tid, String content) async {
     assert(tid > 0, 'Thread ID must be positive');
     assert(content.trim().isNotEmpty, 'Content cannot be empty');
   ```

2. Build URL with query parameters:
   - Base: `$_baseUrl/post.php`
   - Parameters: `act=reply`, `tid` (required), UTF-8 encode content

3. Create POST body: `utf8.encode('content=${Uri.encodeComponent(content)}')`

4. Call `_client.postBytes()` with:
   - URL: constructed above
   - cookieHeaderValue: `_cookie`
   - bodyBytes: encoded body
   - headers: `{'Content-Type': 'application/x-www-form-urlencoded'}`
   - timeout: 30 seconds

5. Check HTTP status: throw if not 200

6. Decode response using existing `_decodeResponse()`

7. Add private helper `_isReplySuccess(String htmlText)` that checks for success indicators:
   - `htmlText.contains('发布成功')`
   - `htmlText.contains('回复成功')`
   - `htmlText.contains('操作成功')`
   - Return true if any match

8. If not success: throw Exception with user-friendly message

9. Use debugPrint for debugging in debug mode (following existing patterns)
  </action>
  <verify>
`flutter analyze nga_app/lib/data/nga_repository.dart` passes without errors, and the file contains `Future<void> postReply(` method definition
  </verify>
  <done>
`postReply(int tid, String content)` method exists in NgaRepository, accepts tid and content, POSTs to NGA API, handles errors, and throws on failure or returns void on success
</done>
</task>

</tasks>

<verification>
Run `flutter analyze` on the modified file and verify the method signature matches the expected contract from the research document.
</verification>

<success_criteria>
- postReply() method added to NgaRepository
- Method accepts thread ID and content parameters
- POST request sent to NGA reply API endpoint
- Loading and error states handled in calling code (Plan 04-02)
- Chinese characters properly encoded via Uri.encodeComponent
</success_criteria>

<output>
After completion, create `.planning/phases/04-replies/04-01-SUMMARY.md`
</output>
