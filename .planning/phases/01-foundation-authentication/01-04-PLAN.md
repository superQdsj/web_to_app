---
phase: 01-foundation-authentication
plan: "04"
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - nga_app/lib/screens/widgets/avatar_button.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - Long-pressing avatar button shows logout confirmation dialog
    - Confirming logout clears all session data and returns to logged-out UI
  artifacts:
    - path: "nga_app/lib/screens/widgets/avatar_button.dart"
      provides: "Long-press logout functionality"
      contains: "longPress"
  key_links:
    - from: "avatar_button.dart"
      to: "NgaCookieStore.clear"
      via: "longPress handler calling clear functions"
      pattern: "longPress.*clear"
    - from: "avatar_button.dart"
      to: "ProfileDrawer._logout"
      via: "reusing logout logic"
      pattern: "_logout|clearStorage|clear"
---

<objective>
Add logout functionality via long-press on avatar button to complete Success Criterion 4.

Purpose: Users need a quick way to log out. Long-press on avatar provides logout access without opening the profile drawer.

Output: AvatarButton with long-press gesture that triggers logout confirmation and clears session.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@nga_app/lib/screens/widgets/avatar_button.dart
@nga_app/lib/screens/widgets/profile_drawer.dart
@nga_app/lib/src/auth/nga_cookie_store.dart
@nga_app/lib/src/auth/nga_user_store.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add long-press logout to AvatarButton</name>
  <files>nga_app/lib/screens/widgets/avatar_button.dart</files>
  <action>Modify `nga_app/lib/screens/widgets/avatar_button.dart`:

1. Add required imports:
   - `package:webview_cookie_manager_plus/webview_cookie_manager_plus.dart`
   - `nga_app/lib/src/auth/nga_user_store.dart`

2. Add a `longPress` callback parameter to AvatarButton constructor:
   ```dart
   final VoidCallback? onLogout;
   const AvatarButton({super.key, required this.onPressed, this.onLogout});
   ```

3. Wrap the GestureDetector with an additional GestureDetector for long-press (only when logged in):
   - Keep existing `onTap` for opening profile drawer
   - Add `onLongPress` that shows confirmation dialog and calls logout
   - Use HapticFeedback.medium() for tactile feedback on long-press
   - Show confirmation dialog using AlertDialog (similar to profile_drawer.dart)

4. The logout confirmation dialog should:
   - Title: "确认登出" (Confirm Logout)
   - Content: "登出将清空本地 Cookie 和 WebView Cookie。" (Logout will clear local and WebView cookies)
   - Cancel button: "取消" (Cancel)
   - Confirm button: "登出" (Logout) with red error color

5. On confirmed logout:
   - Clear cookie: `NgaCookieStore.setCookie('')`
   - Clear storage: `await NgaCookieStore.clearStorage()`
   - Clear user: `await NgaUserStore.clear()`
   - Clear webview cookies: `await WebviewCookieManager().clearCookies()`
   - Show SnackBar: "已退出登录"
   - Trigger `onLogout` callback if provided

6. When NOT logged in, disable long-press (don't show confirmation dialog for logged-out users)

7. Add visual feedback: use `MouseRegion` with `onHover` to show pointer cursor on avatar when logged in.
</action>
  <verify>`fvm flutter analyze nga_app/lib/screens/widgets/avatar_button.dart` returns no errors</verify>
  <done>Long-pressing avatar shows logout confirmation, and confirming logout clears session and returns to logged-out UI</done>
</task>

</tasks>

<verification>
1. Run `fvm flutter analyze nga_app/lib/screens/widgets/avatar_button.dart` - no errors
2. Build and run app - logged-in user can long-press avatar to see logout confirmation
3. Confirming logout shows "已退出登录" snackbar and UI updates to logged-out state
4. Tapping avatar (not long-pressing) still opens profile drawer normally
</verification>

<success_criteria>
- Long-pressing avatar shows logout confirmation dialog when logged in
- Tapping avatar (short press) still opens profile drawer
- Confirming logout clears cookies and user info
- UI returns to logged-out state after logout
- Haptic feedback on long-press for better UX
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-04-SUMMARY.md`
</output>
