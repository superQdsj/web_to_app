---
phase: 01-foundation-authentication
plan: "03"
type: execute
wave: 2
depends_on:
  - "01"
files_modified:
  - nga_app/lib/screens/widgets/avatar_button.dart
  - nga_app/lib/screens/home_screen.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - Avatar button shows user's actual avatar image when logged in
    - Avatar button shows username tooltip or badge when hovered
    - App header changes based on auth state (different title or indicator)
  artifacts:
    - path: "nga_app/lib/screens/widgets/avatar_button.dart"
      provides: "Auth-aware avatar button with real avatar display"
      contains: "NetworkImage.*avatarUrl"
      exports: "AvatarButton"
    - path: "nga_app/lib/screens/home_screen.dart"
      provides: "Header with user info integration"
      contains: "ValueListenableBuilder.*NgaUserStore"
  key_links:
    - from: "avatar_button.dart"
      to: "NgaUserStore.user"
      via: "ValueListenableBuilder"
      pattern: "ValueListenableBuilder.*NgaUserStore.user"
    - from: "avatar_button.dart"
      to: "NetworkImage"
      via: "foregroundImage"
      pattern: "NetworkImage.*avatarUrl"
    - from: "home_screen.dart"
      to: "avatar_button.dart"
      via: "AppBar action"
      pattern: "AvatarButton.*onPressed"
---

<objective>
Update AvatarButton to display actual user avatar and integrate user info into the app header.

Purpose: AUTH-03 requires user identity (avatar, username) displayed throughout app. Currently AvatarButton only shows icons, not actual avatars.

Output: Avatar button shows real avatar image, header displays user context.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@nga_app/lib/screens/widgets/avatar_button.dart
@nga_app/lib/screens/widgets/profile_drawer.dart
@nga_app/lib/screens/home_screen.dart
@nga_app/lib/src/auth/nga_user_store.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AvatarButton to show real avatar</name>
  <files>nga_app/lib/screens/widgets/avatar_button.dart</files>
  <action>Modify `nga_app/lib/screens/widgets/avatar_button.dart` to show real avatar:

1. Change ValueListenableBuilder to listen to `NgaUserStore.user` instead of `NgaCookieStore.cookie`
   - This gives access to user.avatarUrl directly

2. Update the builder to:
   - Check `user?.avatarUrl != null` for logged-in state with avatar
   - Show NetworkImage from `user!.avatarUrl!` as foregroundImage
   - Fallback to person icon if no avatar URL

3. Keep the same CircleAvatar structure but:
   - Increase radius slightly for better avatar visibility (18->20)
   - Add small badge indicator for logged-in state

4. Add Tooltip showing username when logged in:
   - Use Tooltip widget wrapping the avatar
   - Show username in tooltip text

5. Maintain visual distinction between states:
   - Logged out: person_outline icon
   - Logged in with avatar: real avatar image
   - Logged in without avatar: person icon (edge case)

The button should match the ProfileDrawer avatar style but smaller for header use.
</action>
  <verify>`fvm flutter analyze nga_app/lib/screens/widgets/avatar_button.dart` returns no errors</verify>
  <done>Avatar button shows real avatar image from NgaUserStore when logged in</done>
</task>

<task type="auto">
  <name>Task 2: Add auth-aware header to HomeScreen</name>
  <files>nga_app/lib/screens/home_screen.dart</files>
  <action>Modify `nga_app/lib/screens/home_screen.dart` to display user context:

1. Add ValueListenableBuilder wrapping the AppBar or part of it to show auth state

2. Update AppBar title to show:
   - Default "NGA Forum" when not logged in
   - "Hi, {username}" or similar personalized greeting when logged in

3. Optionally add a small indicator (badge or dot) to show login state in header

4. Keep the same structure but add reactive auth state

5. Ensure the transition between states is smooth (automatic rebuild on state change)

The header should subtly communicate the authenticated state without being intrusive.
</action>
  <verify>`fvm flutter analyze nga_app/lib/screens/home_screen.dart` returns no errors</verify>
  <done>HomeScreen header shows username greeting when logged in</done>
</task>

</tasks>

<verification>
1. Run `fvm flutter analyze nga_app/lib/screens/widgets/avatar_button.dart nga_app/lib/screens/home_screen.dart` - no errors
2. Build and run app
3. Open ProfileDrawer and login
4. Verify: avatar button shows actual avatar image in header
5. Verify: tooltip shows username on long-press
6. Verify: header shows personalized greeting
</verification>

<success_criteria>
- Avatar button displays user's actual avatar image (not just icon)
- Avatar tooltip shows username when logged in
- App header shows personalized greeting when logged in
- UI updates reactively on login/logout state changes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`
</output>
