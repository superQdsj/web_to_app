---
phase: 03-thread-reading
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - nga_app/pubspec.yaml
  - nga_app/lib/src/model/thread_detail.dart
  - nga_app/lib/src/parser/thread_parser.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - "ThreadParser extracts image URLs from post HTML content"
    - "ThreadPost model contains imageUrls field"
    - "App can display cached images in posts"
  artifacts:
    - path: "nga_app/pubspec.yaml"
      contains: "cached_network_image: ^3.4.1"
      provides: "Image caching widget"
    - path: "nga_app/pubspec.yaml"
      contains: "flutter_cache_manager: ^3.4.1"
      provides: "Cache infrastructure"
    - path: "nga_app/pubspec.yaml"
      contains: "photo_view: ^0.15.0"
      provides: "Gallery zoom/pan"
    - path: "nga_app/lib/src/model/thread_detail.dart"
      contains: "List<String> imageUrls"
      provides: "Image URLs in post model"
    - path: "nga_app/lib/src/parser/thread_parser.dart"
      contains: "extractImagesFromContent"
      provides: "Image extraction from HTML"
  key_links:
    - from: "thread_parser.dart"
      to: "thread_detail.dart"
      via: "ThreadPost.imageUrls constructor"
      pattern: "ThreadPost\\(.*imageUrls:"
---

<objective>
Add image dependencies to pubspec.yaml and enhance ThreadParser to extract image URLs from post HTML content.

Purpose: Foundation for all image-related features (caching, display, gallery). Without this, images cannot be displayed in posts.
Output: Updated pubspec with dependencies, ThreadPost with imageUrls field, ThreadParser with image extraction.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-thread-reading/03-RESEARCH.md

# Existing patterns from codebase:

ThreadPost model (thread_detail.dart):
```dart
class ThreadPost {
  ThreadPost({
    this.pid,
    required this.floor,
    required this.author,
    required this.authorUid,
    required this.contentText,
    this.deviceType,
    this.postDate,
  });
  // ... fields with toJson()
}
```

ThreadParser (thread_parser.dart):
- Uses html/parser for DOM parsing
- Already extracts contentEl from post rows
- Pattern: `row.querySelector('[id^=postcontent]')`

Image extraction pattern from research:
```dart
final images = contentEl?.querySelectorAll('img').map((img) {
  return img.attributes['src'] ?? img.attributes['data-src'];
}).where((src) => src != null && src.isNotEmpty).toList() ?? [];
```

NGA image URL handling:
- Protocol-relative URLs (`//`) need `https:` prefix
- NGA uses `data-src` for lazy-loaded images
</context>

<tasks>

<task type="auto">
  <name>Add image dependencies to pubspec.yaml</name>
  <files>nga_app/pubspec.yaml</files>
  <action>
Add the following dependencies to the dependencies section of pubspec.yaml:

```yaml
  cached_network_image: ^3.4.1
  flutter_cache_manager: ^3.4.1
  photo_view: ^0.15.0
```

Add these after the existing `shared_preferences` entry (line 46), maintaining the alphabetical-ish ordering of the http/html group.
</action>
  <verify>`cd nga_app && fvm flutter pub get && fvm flutter analyze` passes without errors</verify>
  <done>Dependencies added: cached_network_image, flutter_cache_manager, photo_view available in pubspec.yaml</done>
</task>

<task type="auto">
  <name>Add imageUrls field to ThreadPost model</name>
  <files>nga_app/lib/src/model/thread_detail.dart</files>
  <action>
Update the ThreadPost class to include an imageUrls field:

1. Add `required this.imageUrls` parameter to the constructor (after postDate)
2. Add `final List<String> imageUrls;` field declaration (after postDate)
3. Update `toJson()` to include `'image_urls': imageUrls.map((u) => u).toList()`

The imageUrls list should default to empty list if not provided: `this.imageUrls = const []`

Example structure:
```dart
class ThreadPost {
  ThreadPost({
    this.pid,
    required this.floor,
    required this.author,
    required this.authorUid,
    required this.contentText,
    this.deviceType,
    this.postDate,
    this.imageUrls = const [],
  });

  final int? pid;
  final int? floor;
  final ThreadPostAuthor? author;
  final int? authorUid;
  final String contentText;
  final String? deviceType;
  final String? postDate;
  final List<String> imageUrls;

  Map<String, Object?> toJson() => {
    'pid': pid,
    'floor': floor,
    'author': author?.toJson(),
    'author_uid': authorUid,
    'content_text': contentText,
    'device_type': deviceType,
    'post_date': postDate,
    'image_urls': imageUrls,
  };
}
```
</action>
  <verify>`fvm flutter analyze nga_app/lib/src/model/thread_detail.dart` passes with no errors</verify>
  <done>ThreadPost model has imageUrls field with default empty list</done>
</task>

<task type="auto">
  <name>Enhance ThreadParser with image extraction</name>
  <files>nga_app/lib/src/parser/thread_parser.dart</files>
  <action>
Add image extraction to the ThreadParser class:

1. Add a helper method `String _resolveNgaImageUrl(String url)` at the end of the class:
```dart
String _resolveNgaImageUrl(String url) {
  if (url.startsWith('//')) {
    return 'https:$url';
  }
  if (!url.startsWith('http')) {
    return 'https://img.nga.178.com/$url';
  }
  return url;
}
```

2. Add a helper method `List<String> _extractImagesFromContent(Element? contentEl)`:
```dart
List<String> _extractImagesFromContent(Element? contentEl) {
  if (contentEl == null) return [];
  final images = contentEl.querySelectorAll('img').map((img) {
    // NGA lazy-loads images with data-src attribute
    return img.attributes['data-src'] ?? img.attributes['src'] ?? '';
  }).where((src) => src.isNotEmpty).toList();
  return images.map(_resolveNgaImageUrl).toList();
}
```

3. In the `parseHybrid` method, after extracting `contentText`, add image extraction:
```dart
// Extract images from content
final imageUrls = _extractImagesFromContent(contentEl);
```

4. Update the ThreadPost constructor call to include imageUrls:
```dart
posts.add(
  ThreadPost(
    pid: pid,
    floor: floor,
    author: author,
    authorUid: authorUid,
    contentText: contentText,
    deviceType: deviceType,
    postDate: postDate,
    imageUrls: imageUrls,
  ),
);
```

5. Also update the legacy parser `_parseLegacy` method similarly (around line 134-143) to extract images for fallback parsing.
</action>
  <verify>`fvm flutter analyze nga_app/lib/src/parser/thread_parser.dart` passes with no errors</verify>
  <done>ThreadParser extracts image URLs from post HTML content and populates ThreadPost.imageUrls</done>
</task>

</tasks>

<verification>
Run `fvm flutter analyze` on the entire nga_app project to verify all files compile correctly with the new dependencies and model changes.
</verification>

<success_criteria>
- [ ] cached_network_image, flutter_cache_manager, photo_view added to pubspec.yaml
- [ ] ThreadPost.imageUrls field added with default empty list
- [ ] ThreadParser extracts images from post content using data-src/src attributes
- [ ] Image URLs are resolved (protocol-relative and relative URLs normalized)
- [ ] All code passes `flutter analyze`
</success_criteria>

<output>
After completion, create `.planning/phases/03-thread-reading/03-01-SUMMARY.md`
</output>
