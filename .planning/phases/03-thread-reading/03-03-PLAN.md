---
phase: 03-thread-reading
plan: "03"
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - nga_app/lib/screens/thread/widgets/image_gallery_screen.dart
  - nga_app/lib/screens/thread/thread_post_widgets.dart
  - nga_app/lib/screens/thread/thread_reply_widgets.dart
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can tap any image in a post to view it full-screen"
    - "Full-screen gallery supports swipe navigation between images"
    - "Gallery supports pinch-to-zoom and pan gestures"
  artifacts:
    - path: "nga_app/lib/screens/thread/widgets/image_gallery_screen.dart"
      contains: "PhotoViewGallery"
      provides: "Full-screen gallery with zoom/pan"
  key_links:
    - from: "thread_post_widgets.dart"
      to: "image_gallery_screen.dart"
      via: "Navigator.push with image list"
      pattern: "Navigator\\.push.*ImageGalleryScreen"
---

<objective>
Create ImageGalleryScreen for full-screen image viewing and wire up image taps from posts.

Purpose: Allow users to view images in detail with zoom/pan gestures and swipe navigation.
Output: ImageGalleryScreen with PhotoViewGallery, integrated into _MainPostHeader, _ReplyCard, and _ReplyTile.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-thread-reading/03-RESEARCH.md

# Existing patterns from codebase:

PhotoViewGallery pattern from research:
```dart
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => PhotoViewGallery.builder(
      itemCount: imageUrls.length,
      builder: (context, index) {
        return PhotoViewGalleryPageOptions(
          imageProvider: CachedNetworkImageProvider(
            imageUrls[index],
            cacheManager: NgaImageCacheManager(),
          ),
          minScale: PhotoViewCompressionScale.minimum,
          maxScale: PhotoViewCompressionScale.oversize,
        );
      },
      pageController: PageController(initialPage: initialIndex),
    ),
  ),
);
```

PostImageGrid tap handling:
```dart
PostImageGrid(
  images: post.imageUrls,
  onTap: (index) => _openGallery(post.imageUrls, index),
)

void _openGallery(List<String> images, int initialIndex) {
  Navigator.push(
    context,
    MaterialPageRoute(
      builder: (context) => ImageGalleryScreen(
        imageUrls: images,
        initialIndex: initialIndex,
      ),
    ),
  );
}
```

ThreadPalette colors:
```dart
class _ThreadPalette {
  static const Color backgroundLight = Color(0xFFF5F5F7);
}
```
</context>

<tasks>

<task type="auto">
  <name>Create ImageGalleryScreen widget</name>
  <files>nga_app/lib/screens/thread/widgets/image_gallery_screen.dart</files>
  <action>
Create ImageGalleryScreen using photo_view in lib/screens/thread/widgets/:

```dart
import 'package:flutter/material.dart';
import 'package:photo_view/photo_view.dart';
import 'package:photo_view/photo_view_gallery.dart';
import '../../../src/widgets/image_cache_manager.dart';
import 'package:cached_network_image/cached_network_image.dart';

class ImageGalleryScreen extends StatelessWidget {
  const ImageGalleryScreen({
    super.key,
    required this.imageUrls,
    this.initialIndex = 0,
  });

  final List<String> imageUrls;
  final int initialIndex;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        iconTheme: const IconThemeData(color: Colors.white),
        actions: [
          IconButton(
            icon: const Icon(Icons.close),
            onPressed: () => Navigator.of(context).pop(),
          ),
        ],
      ),
      body: PhotoViewGallery.builder(
        itemCount: imageUrls.length,
        pageController: PageController(initialPage: initialIndex),
        builder: (context, index) {
          return PhotoViewGalleryPageOptions(
            imageProvider: CachedNetworkImageProvider(
              imageUrls[index],
              cacheManager: NgaImageCacheManager(),
            ),
            minScale: PhotoViewCompressionScale.minimum,
            maxScale: PhotoViewCompressionScale.oversize,
            heroAttributes: PhotoViewHeroAttributes(
              tag: 'image_${imageUrls[index]}',
            ),
          );
        },
        backgroundDecoration: const BoxDecoration(color: Colors.black),
      ),
    );
  }
}
```

This screen:
- Uses PhotoViewGallery for swipeable image browsing
- Shows close button in appbar
- Has black background for full immersion
- Uses CachedNetworkImageProvider with NgaImageCacheManager
- Supports pinch-to-zoom and pan gestures
- Uses hero animation for smooth transitions
</action>
  <verify>`fvm flutter analyze nga_app/lib/screens/thread/widgets/image_gallery_screen.dart` passes</verify>
  <done>ImageGalleryScreen created with PhotoViewGallery for full-screen viewing</done>
</task>

<task type="auto">
  <name>Wire up image tap in _MainPostHeader</name>
  <files>nga_app/lib/screens/thread/thread_post_widgets.dart</files>
  <action>
Update _MainPostHeader to open gallery when images are tapped:

1. Modify the _MainPostHeader class to accept a VoidCallback for opening gallery:
```dart
class _MainPostHeader extends StatelessWidget {
  const _MainPostHeader({required this.post, this.onImageTap});

  final ThreadPost post;
  final void Function(List<String> images, int index)? onImageTap;
```

2. Update the PostImageGrid usage to pass onImageTap:
```dart
if (post.imageUrls.isNotEmpty) ...[
  const SizedBox(height: 8),
  PostImageGrid(
    images: post.imageUrls,
    onTap: onImageTap != null
        ? (index) => onImageTap!(post.imageUrls, index)
        : null,
  ),
],
```

3. Update thread_body.dart where _MainPostHeader is instantiated (line 84):
```dart
_MainPostHeader(
  post: mainPost,
  onImageTap: _openGallery,
),
```

4. Add _openGallery method to _ThreadBody or pass it from parent:
   - The easiest: pass a BuildContext and open from _ThreadBody
   - Better: Add a callback parameter to _ThreadBody
   - Even better: Create a helper extension or pass the callback through

Actually, the cleanest approach is to handle this in the parent (_ThreadScreenState):
- Add `void _openGallery(List<String> images, int index)` method to _ThreadScreenState
- Pass it down through _ThreadBody to _MainPostHeader

Update _ThreadBody constructor to accept onImageTap callback, then pass to _MainPostHeader.
</action>
  <verify>`fvm flutter analyze nga_app/lib/screens/thread/thread_post_widgets.dart` passes</verify>
  <done>_MainPostHeader opens ImageGalleryScreen when image is tapped</done>
</task>

<task type="auto">
  <name>Wire up image tap in reply widgets</name>
  <files>nga_app/lib/screens/thread/thread_reply_widgets.dart</files>
  <action>
Update _ReplyCard and _ReplyTile to open gallery when images are tapped:

1. Add onImageTap callback to _ReplyCard:
```dart
class _ReplyCard extends StatelessWidget {
  const _ReplyCard({required this.post, this.onImageTap});

  final ThreadPost post;
  final void Function(List<String> images, int index)? onImageTap;
```

2. Update PostImageGrid in _ReplyCard to pass onImageTap:
```dart
if (post.imageUrls.isNotEmpty) ...[
  const SizedBox(height: 8),
  PostImageGrid(
    images: post.imageUrls,
    onTap: onImageTap != null
        ? (index) => onImageTap!(post.imageUrls, index)
        : null,
  ),
],
```

3. Do the same for _ReplyTile class.

4. Update thread_body.dart where _ReplyCard and _ReplyTile are instantiated:
```dart
_ReplyCard(
  post: post,
  onImageTap: _openGallery,
)

_ReplyTile(
  post: post,
  onImageTap: _openGallery,
)
```
</action>
  <verify>`fvm flutter analyze nga_app/lib/screens/thread/thread_reply_widgets.dart` passes</verify>
  <done>Reply cards and tiles open ImageGalleryScreen when image is tapped</done>
</task>

<task type="checkpoint:human-verify">
  <name>Verify full image viewing flow</name>
  <what-built>
    Complete image viewing feature:
    - ThreadParser extracts images from post HTML
    - Images display with progressive loading in posts
    - Tap any image to open full-screen gallery
    - Gallery supports swipe navigation and pinch-to-zoom
  </what-built>
  <how-to-verify>
    1. Run the app: `cd nga_app && fvm flutter run`
    2. Navigate to a thread that contains images (find a thread with image posts)
    3. Verify:
       - Images appear below post text with loading placeholders
       - Tap any image - gallery opens full-screen
       - Swipe left/right to navigate between images in the same post
       - Pinch-to-zoom works
       - Tap X or swipe down to close gallery
    4. Scroll through thread to verify multiple posts with images work
    5. Verify scrolling remains smooth with images loaded
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Run `fvm flutter analyze` on the entire nga_app project to verify all gallery-related code compiles correctly.
</verification>

<success_criteria>
- [ ] ImageGalleryScreen created with PhotoViewGallery
- [ ] _MainPostHeader opens gallery when image is tapped
- [ ] _ReplyCard opens gallery when image is tapped
- [ ] _ReplyTile opens gallery when image is tapped
- [ ] Gallery supports swipe navigation between images
- [ ] Gallery supports pinch-to-zoom and pan gestures
- [ ] Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/03-thread-reading/03-03-SUMMARY.md`
</output>
