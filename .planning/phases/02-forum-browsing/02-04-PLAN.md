---
phase: 02-forum-browsing
plan: "04"
type: execute
wave: 2
depends_on:
  - "02-01"
  - "02-02"
files_modified:
  - nga_app/lib/screens/forum_screen.dart
  - nga_app/lib/src/services/forum_category_service.dart
autonomous: true
must_haves:
  truths:
    - User can load more threads by scrolling to bottom
    - User can tap "Next Page" button to load more threads
    - Page indicator shows current position (Page X / Total Y)
  artifacts:
    - path: nga_app/lib/screens/forum_screen.dart
      provides: "Pagination UI (load more trigger, page indicator)"
      min_lines: 30
    - path: nga_app/lib/src/services/forum_category_service.dart
      provides: "Thread list pagination with page parameter"
      min_lines: 15
  key_links:
    - from: ForumContent._buildThreadList
      to: ForumCategoryService.getThreads
      via: "page parameter in API call"
    - from: ListView scroll controller
      to: "_loadNextPage"
      via: "scroll controller listener or NotificationListener"
---

<objective>
Implement thread list pagination with "Next Page" button and scroll-to-load functionality.

Purpose: Users need to browse beyond the first page of threads in active boards. The NGA API supports pagination via a `page` parameter.

Output: Updated ForumContent with pagination:
1. API service accepts page parameter and returns thread data with pagination info
2. "Next Page" button appears at bottom of thread list when more pages exist
3. Page indicator shows current position
4. Scrolling to bottom automatically loads more threads
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@nga_app/lib/screens/forum_screen.dart
@nga_app/lib/src/services/forum_category_service.dart
@nga_app/lib/src/model/forum_category.dart
</context>

<tasks>

<task type="auto">
  <name>Add pagination support to ForumCategoryService</name>
  <files>nga_app/lib/src/services/forum_category_service.dart</files>
  <action>
    Modify the thread fetching to support pagination:

    1. Update `getThreads()` method signature to accept `int page = 1` parameter
    2. Add page parameter to the API request (typically as query param `page=N` or `page=1`)
    3. Ensure the method returns pagination metadata:
       - List of threads (same format as before)
       - Current page number
       - Total pages (or hasNextPage boolean)
       - Any pagination info from API response

    The NGA API typically returns thread list with pagination info. Inspect the response to find:
    - Total page count or total thread count
    - Current page indicator

    If pagination info is not in response, track pages incrementally.
  </action>
  <verify>flutter analyze passes and getThreads accepts page parameter</verify>
  <done>ForumCategoryService.getThreads supports page parameter and returns pagination metadata</done>
</task>

<task type="auto">
  <name>Add pagination state and UI to ForumContent</name>
  <files>nga_app/lib/screens/forum_screen.dart</files>
  <action>
    Add pagination state management and UI:

    1. Add state variables to `_ForumContentState`:
       - `_currentPage = 1`
       - `_totalPages` or `_hasNextPage`
       - `_isLoadingMore = false`

    2. Add `_loadNextPage()` method that:
       - Checks if not already loading and has more pages
       - Increments `_currentPage`
       - Fetches threads for new page
       - Appends new threads to `_threads` list
       - Handles errors gracefully

    3. Modify `_buildThreadList()` to wrap ListView with `NotificationListener<ScrollNotification>`:
       - Detect when user scrolls near bottom (scrollExtent > maxScroll - 200)
       - Trigger `_loadNextPage()` when near bottom

    4. Add "Next Page" button at bottom of list when `_hasNextPage` is true:
       - Shows "加载更多" or "第X页/共Y页" indicator
       - Disabled while loading
       - Tappable to explicitly load next page

    5. Add page indicator at top or bottom showing current position.
  </action>
  <verify>flutter analyze passes and pagination UI elements render</verify>
  <done>Thread list shows pagination UI and loads more on scroll/button tap</done>
</task>

<task type="auto">
  <name>Handle pagination edge cases</parameter>
  <files>nga_app/lib/screens/forum_screen.dart</parameter>
  <action>
    Ensure pagination handles edge cases correctly:

    1. Empty board - should still show empty state, no pagination
    2. Last page - should not show "Next Page" button
    3. Loading state - should prevent double-fetching
    4. Error on load more - should show error and allow retry
    5. Board change - should reset pagination to page 1

    Add `_resetPagination()` method called when `setActiveFid` changes.
    Wrap the "load more" section with appropriate error handling UI.

    Test: Switch boards mid-scroll, scroll to bottom on last page, trigger load multiple times rapidly.
  </action>
  <verify>flutter analyze passes and edge cases handled</verify>
  <done>Pagination gracefully handles edge cases without crashes</done>
</task>

</tasks>

<verification>
1. Run `cd nga_app && fvm flutter analyze` - no errors
2. Select a board with many threads
3. Scroll to bottom - should trigger load more or show "Next Page" button
4. Tap "Next Page" - new threads append to list
5. Page indicator shows correct position
6. At last page - no "Next Page" button
7. Switch boards - pagination resets to page 1
</verification>

<success_criteria>
- [ ] flutter analyze passes
- [ ] "Next Page" button appears at bottom when more pages exist
- [ ] Tapping button loads more threads
- [ ] Scrolling near bottom auto-loads more threads
- [ ] Page indicator shows position
- [ ] Last page hides pagination controls
- [ ] Board switch resets pagination
</success_criteria>

<output>
After completion, create `.planning/phases/02-forum-browsing/02-04-SUMMARY.md`
</output>
